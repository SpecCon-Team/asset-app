import{j as e}from"./vendor-charts-DVp8BQgJ.js";import{u as W,h as V,i as K,r as p}from"./vendor-react-CFQdvhEG.js";import{showError as m,showSuccess as N}from"./sweetalert-DcBwdyhg.js";import{u as Z,j as H,a as f,L as Y}from"./index-CezS3iyn.js";import{$ as _,au as j,av as q,ad as z,f as E,aw as J,ax as Q,a7 as X,ah as ee,i as te,T as ae}from"./vendor-ui-Bhgb65c8.js";const re=[{id:"WC",name:"Western Cape",color:"#FF9800"},{id:"EC",name:"Eastern Cape",color:"#8D6E63"},{id:"NC",name:"Northern Cape",color:"#42A5F5"},{id:"FS",name:"Free State",color:"#FFC107"},{id:"KZN",name:"KwaZulu-Natal",color:"#616161"},{id:"NW",name:"North West",color:"#9E9E9E"},{id:"GP",name:"Gauteng",color:"#64B5F6"},{id:"MP",name:"Mpumalanga",color:"#3F51B5"},{id:"LP",name:"Limpopo",color:"#8BC34A"}];function ge(){const x=W(),{tripId:u}=V(),[w]=K(),[se,S]=p.useState([]),[s,y]=p.useState([]),[P,b]=p.useState(!0),[C,T]=p.useState(!1),[h,v]=p.useState("all"),$=Z(P,2e3),g=H()==="PEG";p.useEffect(()=>{var t;if(u)F(u);else{const a=((t=w.get("clients"))==null?void 0:t.split(","))||[];if(a.length===0){m("No Clients","No clients selected. Please go back and select clients."),x("/travel-plan/peg-route-creator");return}A(a)}},[u,w,x]);const F=async t=>{try{b(!0);const l=(await f().get(`/travel/${t}/route`)).data;if(!l||!l.routeStops){m("Route Not Found","The travel plan route could not be found."),x("/travel-plan");return}const r=l.routeStops.map(d=>({id:d.id,clientId:d.clientId,client:d.client,visitDate:new Date(d.visitDate).toISOString().split("T")[0],visitTime:d.visitTime||"09:00",duration:d.duration||60,travelTime:d.travelTime||0,notes:d.notes||"",order:d.order,status:d.status||"planned",completedAt:d.status==="visited"&&d.updatedAt?new Date(d.updatedAt).toISOString():void 0}));y(r),S(r.map(d=>d.client))}catch(a){console.error("Error loading route:",a),m("Error","Failed to load travel plan route"),x("/travel-plan")}finally{b(!1)}},A=async t=>{try{b(!0);const r=(await f().get("/peg")).data.filter(n=>t.includes(n.id));S(r);const d=r.map((n,k)=>{const G=new Date().toISOString().split("T")[0],B=9+k*2,U=`${String(B).padStart(2,"0")}:00`;return{clientId:n.id,client:n,visitDate:G,visitTime:U,duration:60,travelTime:0,notes:"",order:k+1,status:"planned"}});y(d)}catch(a){console.error("Error loading clients:",a),m("Error","Failed to load clients")}finally{b(!1)}},o=(t,a,i)=>{y(l=>l.map((r,d)=>d===t?{...r,[a]:i}:r))},R=async t=>{const a=s[t],i=a.status==="visited"?"planned":"visited",l=i==="visited"?new Date().toISOString():void 0;if(o(t,"status",i),l?o(t,"completedAt",l):o(t,"completedAt",void 0),u&&a.id)try{await f().put(`/travel/route-stops/${a.id}`,{status:i}),N("Updated!",`Delivery marked as ${i==="visited"?"completed":"pending"}`,1500)}catch(r){o(t,"status",a.status),o(t,"completedAt",a.completedAt),console.error("Error updating status:",r),m("Error","Failed to update delivery status")}},D=s.filter(t=>h==="all"?!0:h==="completed"?t.status==="visited":h==="pending"?t.status!=="visited":!0),M=s.length>0&&s.every(t=>t.status==="visited"),O=t=>{y(a=>a.filter((l,r)=>r!==t).map((l,r)=>({...l,order:r+1})))},I=(t,a)=>{a==="up"&&t===0||a==="down"&&t===s.length-1||y(i=>{const l=[...i],r=a==="up"?t-1:t+1;return[l[t],l[r]]=[l[r],l[t]],l.map((d,n)=>({...d,order:n+1}))})},L=async()=>{var t,a;if(s.length===0){m("No Stops","Please add at least one client to the route");return}for(const i of s)if(!i.visitDate||!i.visitTime){m("Missing Information","Please fill in date and time for all stops");return}try{T(!0);const i=f(),l=s.map(n=>new Date(`${n.visitDate}T${n.visitTime}`)),r=new Date(Math.min(...l.map(n=>n.getTime()))),d=new Date(Math.max(...l.map(n=>n.getTime())));if(u){for(const n of s)n.id&&await i.put(`/travel/route-stops/${n.id}`,{visitDate:new Date(`${n.visitDate}T${n.visitTime}`).toISOString(),visitTime:n.visitTime,duration:n.duration,travelTime:n.travelTime||0,notes:n.notes,order:n.order,status:n.status||"planned"});await i.put(`/travel/${u}`,{startDate:r.toISOString(),endDate:d.toISOString()}),N("Updated!","Travel plan route updated successfully",2e3),x("/travel-plan")}else{const n={destination:`PEG Route - ${s.length} clients`,country:"South Africa",startDate:r.toISOString(),endDate:d.toISOString(),category:"business",status:"upcoming",budget:0,spent:0,notes:`Route visiting ${s.length} PEG clients`,routeStops:s.map(c=>({clientId:c.clientId,visitDate:new Date(`${c.visitDate}T${c.visitTime}`).toISOString(),visitTime:c.visitTime,duration:c.duration,travelTime:c.travelTime||0,notes:c.notes,order:c.order,status:c.status||"planned"}))},k=await i.post("/travel/peg-route",n);N("Route Created!","Your PEG client route has been created successfully"),x("/travel-plan")}}catch(i){console.error("Error saving route:",i),m("Error",((a=(t=i.response)==null?void 0:t.data)==null?void 0:a.error)||"Failed to save route")}finally{T(!1)}};return $?e.jsx(Y,{message:"Loading route editor..."}):e.jsxs("div",{className:"p-6 w-full",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("button",{onClick:()=>x(u?"/travel-plan":"/travel-plan/peg-route-creator"),className:"flex items-center gap-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white mb-4",children:[e.jsx(_,{className:"w-5 h-5"}),"Back to Client Selection"]}),e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:g?"View Route Schedule":"Edit Route Schedule"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:g?"View delivery schedule and mark completions":"Set dates and times for each client visit"})]}),M&&s.length>0&&e.jsx("div",{className:"bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-4 mb-6 shadow-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-full flex items-center justify-center",children:e.jsx(j,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold",children:"Route Completed! ðŸŽ‰"}),e.jsxs("p",{className:"text-sm text-green-100",children:["All ",s.length," deliveries have been completed successfully"]})]})]}),e.jsx("button",{onClick:()=>x("/travel-plan"),className:"px-4 py-2 bg-white text-green-600 rounded-lg font-medium hover:bg-green-50 transition-colors",children:"Back to Travel Plan"})]})}),s.length>0&&e.jsxs("div",{className:"mb-4 flex items-center gap-3",children:[e.jsx(q,{className:"w-5 h-5 text-gray-500 dark:text-gray-400"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>v("all"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${h==="all"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:["All (",s.length,")"]}),e.jsxs("button",{onClick:()=>v("completed"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${h==="completed"?"bg-green-600 text-white":"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:["Completed (",s.filter(t=>t.status==="visited").length,")"]}),e.jsxs("button",{onClick:()=>v("pending"),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${h==="pending"?"bg-orange-600 text-white":"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:["Pending (",s.filter(t=>t.status!=="visited").length,")"]})]})]}),s.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Stops"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white mt-1",children:s.length})]}),e.jsx("div",{className:"w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center",children:e.jsx(z,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"})})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Completed"}),e.jsx("p",{className:"text-2xl font-bold text-green-600 dark:text-green-400 mt-1",children:s.filter(t=>t.status==="visited").length})]}),e.jsx("div",{className:"w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center",children:e.jsx(j,{className:"w-6 h-6 text-green-600 dark:text-green-400"})})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Pending"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1",children:s.filter(t=>t.status!=="visited").length})]}),e.jsx("div",{className:"w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center",children:e.jsx(E,{className:"w-6 h-6 text-orange-600 dark:text-orange-400"})})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:"Progress"}),e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-1",children:e.jsx("div",{className:"bg-green-600 h-3 rounded-full transition-all duration-300",style:{width:`${s.filter(t=>t.status==="visited").length/s.length*100}%`}})}),e.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:[Math.round(s.filter(t=>t.status==="visited").length/s.length*100),"% Complete"]})]})})})]}),e.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-blue-900 dark:text-blue-300",children:[s.length," client",s.length!==1?"s":""," in route"]}),e.jsx("p",{className:"text-xs text-blue-700 dark:text-blue-400 mt-1",children:s.map(t=>t.client.name).join(" â†’ ")})]}),!g&&e.jsxs("button",{onClick:L,disabled:C||s.length===0,className:"flex items-center gap-2 px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white rounded-lg font-medium transition-colors",children:[e.jsx(J,{className:"w-5 h-5"}),C?"Saving...":"Save Route"]})]})}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider w-12",children:"Order"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Client"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Province"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Time"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Duration"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Travel Time"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Notes"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider w-32",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:D.map(t=>{const a=s.findIndex(r=>r.clientId===t.clientId&&r.order===t.order),i=re.find(r=>r.id===t.client.provinceId),l=t.status==="visited";return e.jsxs("tr",{className:`hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors ${l?"bg-green-50/50 dark:bg-green-900/10":""}`,children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-4 h-4 text-gray-400 cursor-move"}),e.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t.order})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:t.client.name}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:t.client.location})]})}),e.jsx("td",{className:"px-4 py-3",children:i&&e.jsx("span",{className:"px-2 py-1 text-xs font-medium text-white rounded whitespace-nowrap inline-block",style:{backgroundColor:i.color},title:i.name,children:i.name})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"relative",children:[e.jsx(X,{className:"absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"date",value:t.visitDate,onChange:r=>o(a,"visitDate",r.target.value),disabled:g,className:"pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"relative",children:[e.jsx(E,{className:"absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"time",value:t.visitTime,onChange:r=>o(a,"visitTime",r.target.value),disabled:g,className:"pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("select",{value:t.duration,onChange:r=>o(a,"duration",parseInt(r.target.value)),disabled:g,className:"px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx("option",{value:30,children:"30 min"}),e.jsx("option",{value:60,children:"1 hour"}),e.jsx("option",{value:90,children:"1.5 hours"}),e.jsx("option",{value:120,children:"2 hours"}),e.jsx("option",{value:180,children:"3 hours"}),e.jsx("option",{value:240,children:"4 hours"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"number",min:"0",step:"5",value:t.travelTime||0,onChange:r=>o(a,"travelTime",parseInt(r.target.value)||0),placeholder:"0",disabled:g,className:"pl-8 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"}),e.jsx("span",{className:"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-500 dark:text-gray-400",children:"min"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("input",{type:"text",value:t.notes,onChange:r=>o(a,"notes",r.target.value),placeholder:"Notes...",disabled:g,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:`inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded-full ${l?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}`,children:l?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"w-3 h-3"}),"Completed"]}):"Pending"}),l&&t.completedAt&&e.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:new Date(t.completedAt).toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>R(a),className:`p-2 rounded-lg transition-all ${l?"bg-green-100 text-green-600 hover:bg-green-200 dark:bg-green-900/30 dark:text-green-400 dark:hover:bg-green-900/50":"bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"}`,title:l?"Mark as pending":"Mark as completed",children:l?e.jsx(j,{className:"w-5 h-5"}):e.jsx(te,{className:"w-5 h-5"})}),!g&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>I(a,"up"),disabled:a===0,className:"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30",title:"Move up",children:"â†‘"}),e.jsx("button",{onClick:()=>I(a,"down"),disabled:a===s.length-1,className:"p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30",title:"Move down",children:"â†“"}),e.jsx("button",{onClick:()=>O(a),className:"p-1 text-red-400 hover:text-red-600",title:"Remove",children:e.jsx(ae,{className:"w-4 h-4"})})]})]})})]},t.clientId)})})]})})}),s.length===0&&e.jsx("div",{className:"text-center py-12 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700",children:e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No clients in route"})}),s.length>0&&D.length===0&&e.jsxs("div",{className:"text-center py-12 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700",children:[e.jsxs("p",{className:"text-gray-500 dark:text-gray-400",children:["No ",h==="completed"?"completed":"pending"," deliveries found"]}),e.jsx("button",{onClick:()=>v("all"),className:"mt-2 text-blue-600 dark:text-blue-400 hover:underline",children:"Show all deliveries"})]})]})}export{ge as default};
