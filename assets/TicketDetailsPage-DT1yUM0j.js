import{j as e}from"./vendor-charts-DVp8BQgJ.js";import{r as i,h as Z,u as ee}from"./vendor-react-CFQdvhEG.js";import{u as te}from"./store-CvGvBtmy.js";import{l as q}from"./api-BAoJM9u4.js";import{i as se,b as G,d as ae,g as B,e as J}from"./index-BQg6k2HC.js";import{showWarning as _,showError as v,showSuccess as L,showConfirm as re}from"./sweetalert-DcBwdyhg.js";import"./types-D8_qC6eW.js";import"./vendor-ui-Bhgb65c8.js";let P=!1;function H(){const a=document.cookie.split(";");for(const d of a){const[m,s]=d.trim().split("=");if(m==="csrfToken")return decodeURIComponent(s)}return null}async function Y(){try{return(await(await fetch(`${B()}/auth/csrf-token`,{credentials:"include"})).json()).csrfToken||null}catch(a){return console.warn("Failed to fetch CSRF token:",a),null}}function ne({ticketId:a}){const[d,m]=i.useState([]),[s,C]=i.useState(""),[b,S]=i.useState(""),[T,D]=i.useState(null),[p,U]=i.useState([]),[c,j]=i.useState(!1),[f,y]=i.useState(!0),[g,E]=i.useState(!1),w=se(),O=G(),I=i.useRef(0),A=i.useRef(0),x=i.useRef(!1);i.useEffect(()=>{if(!a){console.warn("CommentSection: No ticketId provided"),y(!1);return}k(),M(),$();const t=setInterval(()=>{a&&k()},1e4);return()=>clearInterval(t)},[a]);const $=async()=>{const t=ae();if(t)try{const r=(await q()).find(o=>o.email===t);r&&(D(r.id),S(r.id))}catch(n){console.error("Error finding current user:",n)}},M=async()=>{try{const t=await q();U(t)}catch(t){console.error("Error fetching users:",t)}},k=async()=>{if(!a||a==="undefined"||a==="null"){console.warn("CommentSection.fetchComments: Invalid ticketId:",a),y(!1);return}try{const t=localStorage.getItem("token"),n={"Content-Type":"application/json"};t&&(n.Authorization=`Bearer ${t}`);const r=await fetch(`${B()}/comments/ticket/${a}`,{credentials:"include",headers:n});if(!r.ok){const l=await r.text();if(console.error(`Failed to fetch comments for ticket ${a}:`,{status:r.status,statusText:r.statusText,body:l}),r.status===404){console.warn("Ticket not found or no access to comments"),m([]);return}throw new Error(`Failed to fetch comments: ${r.status}`)}const o=await r.json();m(o)}catch(t){console.error("Error fetching comments:",t)}finally{y(!1)}},z=async t=>{if(t&&(t.preventDefault(),t.stopPropagation()),!(P||x.current||g||c)){P=!0,x.current=!0,E(!0),j(!0);try{const n=w?b:T;if(!s.trim()){await _("Missing Comment","Please enter a comment");return}if(!n){await v("Authentication Error","Unable to identify user. Please try logging in again.");return}const r=`lastComment_${n}_${a}`,o=localStorage.getItem(r);if(o)try{const{content:u,timestamp:W}=JSON.parse(o),Q=Date.now()-W;if(u===s.trim()&&Q<3e4){await _("Duplicate Comment","You already submitted this exact comment. Please wait 30 seconds to submit it again.");return}}catch(u){console.error("Error reading localStorage:",u)}A.current+=1;const l=Date.now();if(l-I.current<5e3){await _("Please Wait","Please wait 5 seconds between comments");return}I.current=l;const h=localStorage.getItem("token"),N={"Content-Type":"application/json"};h&&(N.Authorization=`Bearer ${h}`);let R=H();R||(R=await Y()),R&&(N["X-CSRF-Token"]=R);const K=`${n}-${a}-${Date.now()}`,X=await fetch(`${B()}/comments`,{method:"POST",headers:{...N,"X-Request-ID":K},credentials:"include",body:JSON.stringify({content:s,ticketId:a,authorId:n})});if(!X.ok)throw new Error("Failed to create comment");const V=await X.json();localStorage.setItem(r,JSON.stringify({content:s.trim(),timestamp:Date.now(),commentId:V.id})),setTimeout(()=>{try{const u=localStorage.getItem(r);if(u){const{timestamp:W}=JSON.parse(u);Date.now()-W>6e4&&localStorage.removeItem(r)}}catch(u){console.error("Error cleaning localStorage:",u)}},6e4),C(""),await new Promise(u=>setTimeout(u,1e3)),await k(),await L("Success!","Comment added successfully!",1500)}catch(n){await v("Error","Failed to add comment"),console.error("Error creating comment:",n)}finally{j(!1),E(!1),x.current=!1,P=!1}}},F=async t=>{if((await re("Delete Comment?","Are you sure you want to delete this comment? This action cannot be undone.","Yes, delete it","Cancel")).isConfirmed)try{const r=localStorage.getItem("token"),o={"Content-Type":"application/json"};r&&(o.Authorization=`Bearer ${r}`);let l=H();if(l||(l=await Y()),l&&(o["X-CSRF-Token"]=l),!(await fetch(`${B()}/comments/${t}`,{method:"DELETE",credentials:"include",headers:o})).ok)throw new Error("Failed to delete comment");m(d.filter(N=>N.id!==t)),await L("Deleted!","Comment deleted successfully!",1500)}catch(r){await v("Error","Failed to delete comment"),console.error("Error deleting comment:",r)}};return a?f?e.jsx("div",{className:"p-4",children:"Loading comments..."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:["Comments (",d.length,")"]}),e.jsx("button",{onClick:k,className:"text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",title:"Refresh to see new comments",children:"ðŸ”„ Refresh"})]}),e.jsx("div",{className:"space-y-3",children:d.length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"No comments yet. Be the first to comment!"}):d.map(t=>{const n=t.author.role;let r,o,l,h;return n==="ADMIN"?(r="bg-purple-50 dark:bg-purple-900/30",o="border-purple-300 dark:border-purple-700",l="bg-purple-600 dark:bg-purple-500",h="Admin"):n==="TECHNICIAN"?(r="bg-blue-50 dark:bg-blue-900/30",o="border-blue-300 dark:border-blue-700",l="bg-blue-600 dark:bg-blue-500",h="Technician"):(r="bg-green-50 dark:bg-green-900/30",o="border-green-300 dark:border-green-700",l="bg-green-600 dark:bg-green-500",h="User"),e.jsxs("div",{className:`rounded-lg p-4 border ${r} ${o}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900 dark:text-white",children:t.author.name||t.author.email}),e.jsx("span",{className:`px-2 py-0.5 text-xs ${l} text-white rounded-full font-medium`,children:h}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-xs",children:J(t.createdAt)})]}),O&&e.jsx("button",{onClick:()=>F(t.id),className:"text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-sm",children:"Delete"})]}),e.jsx("p",{className:"text-gray-900 dark:text-gray-100 whitespace-pre-wrap",children:t.content})]},t.id)})}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-white mb-3",children:"Add a Comment"}),w&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"commentUser",className:"block text-sm font-medium text-gray-900 dark:text-white mb-2",children:"Comment as:"}),e.jsxs("select",{id:"commentUser",value:b,onChange:t=>S(t.target.value),className:"w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Select a user"}),p.map(t=>e.jsx("option",{value:t.id,children:t.name||t.email},t.id))]})]}),e.jsx("textarea",{value:s,onChange:t=>C(t.target.value),placeholder:"Write your comment here...",rows:4,className:"w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("button",{type:"button",onClick:t=>{t.preventDefault(),t.stopPropagation(),!(P||x.current||g||c)&&z(t)},disabled:g||c||!w&&!T||!s.trim(),className:`mt-2 px-4 py-2 min-h-[44px] bg-blue-600 dark:bg-blue-500 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 ${g||c?"pointer-events-none opacity-50":""}`,style:{pointerEvents:g||c?"none":"auto"},children:g||c?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("span",{className:"sr-only",children:"Submitting"})]}):"Add Comment"})]})]}):e.jsx("div",{className:"p-4 text-gray-500",children:"No ticket selected"})}function xe(){var F;const{id:a}=Z(),d=ee(),m=G(),{currentTicket:s,isLoading:C,fetchTicketById:b,updateTicket:S,deleteTicket:T,clearCurrentTicket:D}=te(),[p,U]=i.useState(""),[c,j]=i.useState(""),[f,y]=i.useState(""),[g,E]=i.useState([]),[w,O]=i.useState(!0),[I,A]=i.useState(!1),[x,$]=i.useState(!1);i.useEffect(()=>(a&&b(a),()=>D()),[a,b,D]),i.useEffect(()=>{(async()=>{try{const n=await q();E(n)}catch(n){console.error("Error fetching users:",n)}finally{O(!1)}})()},[]),i.useEffect(()=>{s&&(U(s.status||""),j(s.priority||""),y(s.assignedToId||""))},[s]);const M=async()=>{if(a){if(x||!(p!==(s==null?void 0:s.status)||c!==(s==null?void 0:s.priority)||f!==((s==null?void 0:s.assignedToId)||"")))return;$(!0);try{await S(a,{status:p,priority:c,assignedToId:f||null}),await L("Success!","Ticket updated successfully!",1500),b(a)}catch(n){await v("Error","Failed to update ticket"),console.error("Update error:",n)}finally{$(!1)}}},k=async()=>{if(a)try{await T(a),await L("Deleted!","Ticket deleted successfully!",1500),d("/tickets")}catch(t){await v("Error","Failed to delete ticket"),console.error("Delete error:",t)}};if(C)return e.jsx("div",{className:"p-8",children:"Loading ticket details..."});if(!s)return e.jsx("div",{className:"p-8",children:"Ticket not found"});const z=p!==s.status||c!==s.priority||f!==(s.assignedToId||"");return e.jsxs("div",{className:"p-8 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-6 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("button",{onClick:()=>d(m?"/tickets":"/my/tickets"),className:"text-blue-600 hover:text-blue-800 mb-4 block",children:"â† Back to Tickets"}),e.jsx("h1",{className:"text-3xl font-bold dark:text-white",children:"Ticket Details"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300",children:["Ticket #",s.number||s.id]})]}),m&&e.jsx("button",{onClick:()=>A(!0),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Delete Ticket"})]}),I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 dark:text-white",children:"Delete Ticket?"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300 mb-6",children:["Are you sure you want to delete ticket ",e.jsxs("strong",{children:["#",s.number]}),"? This action cannot be undone."]}),e.jsxs("div",{className:"flex gap-4 justify-end",children:[e.jsx("button",{onClick:()=>A(!1),className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600",children:"Cancel"}),e.jsx("button",{onClick:k,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Delete"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-8 space-y-6",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-xl font-semibold mb-2 dark:text-white",children:s.title})}),!m&&e.jsxs("div",{className:"grid grid-cols-3 gap-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Status"}),e.jsx("span",{className:"inline-flex px-3 py-1 text-sm rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200",children:((F=s.status)==null?void 0:F.replace("_"," "))||"Open"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Priority"}),e.jsx("span",{className:"inline-flex px-3 py-1 text-sm rounded-full bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200",children:s.priority||"Medium"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Assigned To"}),e.jsx("span",{className:"text-sm text-gray-900 dark:text-white",children:s.assignedTo?`${s.assignedTo.name||s.assignedTo.email}`:"Unassigned"})]})]}),m&&e.jsxs("div",{className:"grid grid-cols-3 gap-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 dark:text-gray-200",children:"Status"}),e.jsxs("select",{value:p,onChange:t=>U(t.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"closed",children:"Closed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 dark:text-gray-200",children:"Priority"}),e.jsxs("select",{value:c,onChange:t=>j(t.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"critical",children:"Critical"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 dark:text-gray-200",children:"Assign To"}),e.jsxs("select",{value:f,onChange:t=>y(t.target.value),disabled:w,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Unassigned"}),g.map(t=>e.jsx("option",{value:t.id,children:t.name||t.email},t.id))]})]}),e.jsx("div",{className:"col-span-3",children:e.jsx("button",{onClick:M,disabled:!z||x,className:"px-6 py-2 min-h-[44px] bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2",children:x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("span",{className:"sr-only",children:"Updating"})]}):"Update Ticket"})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Description"}),e.jsx("div",{className:"p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:e.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:s.description||"No description provided"})})]}),s.resolution&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Resolution"}),e.jsx("div",{className:"p-4 bg-green-50 dark:bg-green-900/50 border border-green-200 dark:border-green-700 rounded-lg",children:e.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:s.resolution})})]})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-8",children:e.jsx(ne,{ticketId:s.id})})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h3",{className:"font-semibold mb-4 dark:text-white",children:"Ticket Information"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Created by:"}),e.jsx("p",{className:"font-medium mt-1 dark:text-white",children:s.createdBy?e.jsxs(e.Fragment,{children:[s.createdBy.name||s.createdBy.email,s.createdBy.isWhatsAppUser&&e.jsx("span",{className:"ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200",children:"ðŸ“± WhatsApp"}),s.createdBy.phone&&e.jsx("span",{className:"block text-xs text-gray-500 dark:text-gray-400 mt-1",children:s.createdBy.phone})]}):"Unknown User"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Assigned to:"}),e.jsx("p",{className:"font-medium mt-1 dark:text-white",children:s.assignedTo?`${s.assignedTo.name||s.assignedTo.email}`:"Unassigned"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Created at:"}),e.jsx("p",{className:"font-medium mt-1 dark:text-white",children:J(s.createdAt)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Updated at:"}),e.jsx("p",{className:"font-medium mt-1 dark:text-white",children:J(s.updatedAt)})]}),s.asset&&e.jsxs("div",{className:"pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 block mb-2",children:"Related Asset:"}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/50 p-3 rounded-lg",children:[e.jsx("p",{className:"font-semibold text-blue-900 dark:text-blue-200",children:s.asset.name}),e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300 mt-1",children:["Code: ",s.asset.asset_code]}),e.jsxs("p",{className:"text-xs text-blue-600 dark:text-blue-400 mt-1",children:["Status: ",e.jsx("span",{className:"font-medium capitalize",children:s.asset.status})]}),e.jsx("button",{onClick:()=>{var t;return d(`/assets/${(t=s.asset)==null?void 0:t.id}`)},className:"mt-2 text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 underline",children:"View asset details â†’"})]})]})]})]})})]})]})}export{xe as default};
