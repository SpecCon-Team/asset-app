import{r as i,p as V,q as H,s as X,e as M,j as e,t as z,m as Q,u as Z}from"./index-BqeTFePD.js";import{u as ee}from"./store-KM3UOiGj.js";import{l as W}from"./api-D6QJUkA-.js";import{showWarning as q,showError as N,showSuccess as B,showConfirm as te}from"./sweetalert-BCvQYi5m.js";import"./types-D8_qC6eW.js";let P=!1;function se({ticketId:r}){const[u,x]=i.useState([]),[s,v]=i.useState(""),[b,C]=i.useState(""),[S,T]=i.useState(null),[p,D]=i.useState([]),[o,k]=i.useState(!1),[y,f]=i.useState(!0),[g,U]=i.useState(!1),w=V(),F=H(),E=i.useRef(0),I=i.useRef(0),h=i.useRef(!1);i.useEffect(()=>{if(!r){console.warn("CommentSection: No ticketId provided"),f(!1);return}j(),R(),A();const t=setInterval(()=>{r&&j()},1e4);return()=>clearInterval(t)},[r]);const A=async()=>{const t=X();if(t)try{const a=(await W()).find(l=>l.email===t);a&&(T(a.id),C(a.id))}catch(n){console.error("Error finding current user:",n)}},R=async()=>{try{const t=await W();D(t)}catch(t){console.error("Error fetching users:",t)}},j=async()=>{if(!r||r==="undefined"||r==="null"){console.warn("CommentSection.fetchComments: Invalid ticketId:",r),f(!1);return}try{const t=localStorage.getItem("token"),n={"Content-Type":"application/json"};t&&(n.Authorization=`Bearer ${t}`);const a=await fetch(`${M()}/comments/ticket/${r}`,{credentials:"include",headers:n});if(!a.ok){const d=await a.text();if(console.error(`Failed to fetch comments for ticket ${r}:`,{status:a.status,statusText:a.statusText,body:d}),a.status===404){console.warn("Ticket not found or no access to comments"),x([]);return}throw new Error(`Failed to fetch comments: ${a.status}`)}const l=await a.json();x(l)}catch(t){console.error("Error fetching comments:",t)}finally{f(!1)}},L=async t=>{if(t&&(t.preventDefault(),t.stopPropagation()),!(P||h.current||g||o)){P=!0,h.current=!0,U(!0),k(!0);try{const n=w?b:S;if(!s.trim()){await q("Missing Comment","Please enter a comment");return}if(!n){await N("Authentication Error","Unable to identify user. Please try logging in again.");return}const a=`lastComment_${n}_${r}`,l=localStorage.getItem(a);if(l)try{const{content:c,timestamp:O}=JSON.parse(l),K=Date.now()-O;if(c===s.trim()&&K<3e4){await q("Duplicate Comment","You already submitted this exact comment. Please wait 30 seconds to submit it again.");return}}catch(c){console.error("Error reading localStorage:",c)}I.current+=1;const d=Date.now();if(d-E.current<5e3){await q("Please Wait","Please wait 5 seconds between comments");return}E.current=d;const m=localStorage.getItem("token"),_={"Content-Type":"application/json"};m&&(_.Authorization=`Bearer ${m}`);const Y=`${n}-${r}-${Date.now()}`,J=await fetch(`${M()}/comments`,{method:"POST",headers:{..._,"X-Request-ID":Y},credentials:"include",body:JSON.stringify({content:s,ticketId:r,authorId:n})});if(!J.ok)throw new Error("Failed to create comment");const G=await J.json();localStorage.setItem(a,JSON.stringify({content:s.trim(),timestamp:Date.now(),commentId:G.id})),setTimeout(()=>{try{const c=localStorage.getItem(a);if(c){const{timestamp:O}=JSON.parse(c);Date.now()-O>6e4&&localStorage.removeItem(a)}}catch(c){console.error("Error cleaning localStorage:",c)}},6e4),v(""),await new Promise(c=>setTimeout(c,1e3)),await j(),await B("Success!","Comment added successfully!",1500)}catch(n){await N("Error","Failed to add comment"),console.error("Error creating comment:",n)}finally{k(!1),U(!1),h.current=!1,P=!1}}},$=async t=>{if((await te("Delete Comment?","Are you sure you want to delete this comment? This action cannot be undone.","Yes, delete it","Cancel")).isConfirmed)try{const a=localStorage.getItem("token"),l={"Content-Type":"application/json"};if(a&&(l.Authorization=`Bearer ${a}`),!(await fetch(`${M()}/comments/${t}`,{method:"DELETE",credentials:"include",headers:l})).ok)throw new Error("Failed to delete comment");x(u.filter(m=>m.id!==t)),await B("Deleted!","Comment deleted successfully!",1500)}catch(a){await N("Error","Failed to delete comment"),console.error("Error deleting comment:",a)}};return r?y?e.jsx("div",{className:"p-4",children:"Loading comments..."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:["Comments (",u.length,")"]}),e.jsx("button",{onClick:j,className:"text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",title:"Refresh to see new comments",children:"ðŸ”„ Refresh"})]}),e.jsx("div",{className:"space-y-3",children:u.length===0?e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"No comments yet. Be the first to comment!"}):u.map(t=>{const n=t.author.role;let a,l,d,m;return n==="ADMIN"?(a="bg-purple-50 dark:bg-purple-900/30",l="border-purple-300 dark:border-purple-700",d="bg-purple-600 dark:bg-purple-500",m="Admin"):n==="TECHNICIAN"?(a="bg-blue-50 dark:bg-blue-900/30",l="border-blue-300 dark:border-blue-700",d="bg-blue-600 dark:bg-blue-500",m="Technician"):(a="bg-green-50 dark:bg-green-900/30",l="border-green-300 dark:border-green-700",d="bg-green-600 dark:bg-green-500",m="User"),e.jsxs("div",{className:`rounded-lg p-4 border ${a} ${l}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-sm text-gray-900 dark:text-white",children:t.author.name||t.author.email}),e.jsx("span",{className:`px-2 py-0.5 text-xs ${d} text-white rounded-full font-medium`,children:m}),e.jsx("span",{className:"text-gray-500 dark:text-gray-400 text-xs",children:z(t.createdAt)})]}),F&&e.jsx("button",{onClick:()=>$(t.id),className:"text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 text-sm",children:"Delete"})]}),e.jsx("p",{className:"text-gray-900 dark:text-gray-100 whitespace-pre-wrap",children:t.content})]},t.id)})}),e.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsx("h4",{className:"font-semibold text-gray-900 dark:text-white mb-3",children:"Add a Comment"}),w&&e.jsxs("div",{className:"mb-3",children:[e.jsx("label",{htmlFor:"commentUser",className:"block text-sm font-medium text-gray-900 dark:text-white mb-2",children:"Comment as:"}),e.jsxs("select",{id:"commentUser",value:b,onChange:t=>C(t.target.value),className:"w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Select a user"}),p.map(t=>e.jsx("option",{value:t.id,children:t.name||t.email},t.id))]})]}),e.jsx("textarea",{value:s,onChange:t=>v(t.target.value),placeholder:"Write your comment here...",rows:4,className:"w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("button",{type:"button",onClick:t=>{t.preventDefault(),t.stopPropagation(),!(P||h.current||g||o)&&L(t)},disabled:g||o||!w&&!S||!s.trim(),className:`mt-2 px-4 py-2 min-h-[44px] bg-blue-600 dark:bg-blue-500 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2 ${g||o?"pointer-events-none opacity-50":""}`,style:{pointerEvents:g||o?"none":"auto"},children:g||o?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("span",{className:"sr-only",children:"Submitting"})]}):"Add Comment"})]})]}):e.jsx("div",{className:"p-4 text-gray-500",children:"No ticket selected"})}function oe(){var $;const{id:r}=Q(),u=Z(),x=H(),{currentTicket:s,isLoading:v,fetchTicketById:b,updateTicket:C,deleteTicket:S,clearCurrentTicket:T}=ee(),[p,D]=i.useState(""),[o,k]=i.useState(""),[y,f]=i.useState(""),[g,U]=i.useState([]),[w,F]=i.useState(!0),[E,I]=i.useState(!1),[h,A]=i.useState(!1);i.useEffect(()=>(r&&b(r),()=>T()),[r,b,T]),i.useEffect(()=>{(async()=>{try{const n=await W();U(n)}catch(n){console.error("Error fetching users:",n)}finally{F(!1)}})()},[]),i.useEffect(()=>{s&&(D(s.status||""),k(s.priority||""),f(s.assignedToId||""))},[s]);const R=async()=>{if(r){if(h||!(p!==(s==null?void 0:s.status)||o!==(s==null?void 0:s.priority)||y!==((s==null?void 0:s.assignedToId)||"")))return;A(!0);try{await C(r,{status:p,priority:o,assignedToId:y||null}),await B("Success!","Ticket updated successfully!",1500),b(r)}catch(n){await N("Error","Failed to update ticket"),console.error("Update error:",n)}finally{A(!1)}}},j=async()=>{if(r)try{await S(r),await B("Deleted!","Ticket deleted successfully!",1500),u("/tickets")}catch(t){await N("Error","Failed to delete ticket"),console.error("Delete error:",t)}};if(v)return e.jsx("div",{className:"p-8",children:"Loading ticket details..."});if(!s)return e.jsx("div",{className:"p-8",children:"Ticket not found"});const L=p!==s.status||o!==s.priority||y!==(s.assignedToId||"");return e.jsxs("div",{className:"p-8 max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-6 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("button",{onClick:()=>u(x?"/tickets":"/my/tickets"),className:"text-blue-600 hover:text-blue-800 mb-4 block",children:"â† Back to Tickets"}),e.jsx("h1",{className:"text-3xl font-bold dark:text-white",children:"Ticket Details"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300",children:["Ticket #",s.number||s.id]})]}),x&&e.jsx("button",{onClick:()=>I(!0),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Delete Ticket"})]}),E&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 dark:text-white",children:"Delete Ticket?"}),e.jsxs("p",{className:"text-gray-600 dark:text-gray-300 mb-6",children:["Are you sure you want to delete ticket ",e.jsxs("strong",{children:["#",s.number]}),"? This action cannot be undone."]}),e.jsxs("div",{className:"flex gap-4 justify-end",children:[e.jsx("button",{onClick:()=>I(!1),className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600",children:"Cancel"}),e.jsx("button",{onClick:j,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Delete"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-8 space-y-6",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-xl font-semibold mb-2 dark:text-white",children:s.title})}),!x&&e.jsxs("div",{className:"grid grid-cols-3 gap-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Status"}),e.jsx("span",{className:"inline-flex px-3 py-1 text-sm rounded-full bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200",children:(($=s.status)==null?void 0:$.replace("_"," "))||"Open"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Priority"}),e.jsx("span",{className:"inline-flex px-3 py-1 text-sm rounded-full bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200",children:s.priority||"Medium"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Assigned To"}),e.jsx("span",{className:"text-sm text-gray-900 dark:text-white",children:s.assignedTo?`${s.assignedTo.name||s.assignedTo.email}`:"Unassigned"})]})]}),x&&e.jsxs("div",{className:"grid grid-cols-3 gap-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 dark:text-gray-200",children:"Status"}),e.jsxs("select",{value:p,onChange:t=>D(t.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"closed",children:"Closed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 dark:text-gray-200",children:"Priority"}),e.jsxs("select",{value:o,onChange:t=>k(t.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"critical",children:"Critical"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2 dark:text-gray-200",children:"Assign To"}),e.jsxs("select",{value:y,onChange:t=>f(t.target.value),disabled:w,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Unassigned"}),g.map(t=>e.jsx("option",{value:t.id,children:t.name||t.email},t.id))]})]}),e.jsx("div",{className:"col-span-3",children:e.jsx("button",{onClick:R,disabled:!L||h,className:"px-6 py-2 min-h-[44px] bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2",children:h?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("span",{className:"sr-only",children:"Updating"})]}):"Update Ticket"})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Description"}),e.jsx("div",{className:"p-4 bg-gray-50 dark:bg-gray-700 rounded-lg",children:e.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:s.description||"No description provided"})})]}),s.resolution&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Resolution"}),e.jsx("div",{className:"p-4 bg-green-50 dark:bg-green-900/50 border border-green-200 dark:border-green-700 rounded-lg",children:e.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:s.resolution})})]})]}),e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-8",children:e.jsx(se,{ticketId:s.id})})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6",children:[e.jsx("h3",{className:"font-semibold mb-4 dark:text-white",children:"Ticket Information"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Created by:"}),e.jsx("p",{className:"font-medium mt-1 dark:text-white",children:s.createdBy?e.jsxs(e.Fragment,{children:[s.createdBy.name||s.createdBy.email,s.createdBy.isWhatsAppUser&&e.jsx("span",{className:"ml-2 inline-flex items-center px-2 py-0.5 text-xs rounded-full bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200",children:"ðŸ“± WhatsApp"}),s.createdBy.phone&&e.jsx("span",{className:"block text-xs text-gray-500 dark:text-gray-400 mt-1",children:s.createdBy.phone})]}):"Unknown User"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Assigned to:"}),e.jsx("p",{className:"font-medium mt-1 dark:text-white",children:s.assignedTo?`${s.assignedTo.name||s.assignedTo.email}`:"Unassigned"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Created at:"}),e.jsx("p",{className:"font-medium mt-1 dark:text-white",children:z(s.createdAt)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400",children:"Updated at:"}),e.jsx("p",{className:"font-medium mt-1 dark:text-white",children:z(s.updatedAt)})]}),s.asset&&e.jsxs("div",{className:"pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("span",{className:"text-gray-500 dark:text-gray-400 block mb-2",children:"Related Asset:"}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/50 p-3 rounded-lg",children:[e.jsx("p",{className:"font-semibold text-blue-900 dark:text-blue-200",children:s.asset.name}),e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300 mt-1",children:["Code: ",s.asset.asset_code]}),e.jsxs("p",{className:"text-xs text-blue-600 dark:text-blue-400 mt-1",children:["Status: ",e.jsx("span",{className:"font-medium capitalize",children:s.asset.status})]}),e.jsx("button",{onClick:()=>{var t;return u(`/assets/${(t=s.asset)==null?void 0:t.id}`)},className:"mt-2 text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 underline",children:"View asset details â†’"})]})]})]})]})})]})]})}export{oe as default};
