generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                 @id @default(cuid())
  email                  String                 @unique
  name                   String?
  password               String
  role                   Role                   @default(USER)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  backupCodes            String?
  bio                    String?
  department             String?
  emailVerified          Boolean                @default(false)
  isAvailable            Boolean                @default(true)
  isWhatsAppUser         Boolean                @default(false)
  location               String?
  lockoutUntil           DateTime?
  loginAttempts          Int                    @default(0)
  passwordHistory        String?
  phone                  String?
  profilePicture         String?
  resetPasswordExpiry    DateTime?
  resetPasswordToken     String?
  twoFactorEnabled       Boolean                @default(false)
  twoFactorSecret        String?
  verificationExpiry     DateTime?
  verificationOTP        String?
  whatsAppNotifications  Boolean                @default(true)
  currentAssets          Asset[]                @relation("AssetCurrentHolder")
  assets                 Asset[]
  checkedInBy            AssetCheckout[]        @relation("CheckedInBy")
  checkedOutBy           AssetCheckout[]        @relation("CheckedOutBy")
  checkouts              AssetCheckout[]        @relation("CheckoutUser")
  depreciationsCreated   AssetDepreciation[]
  disposalsApproved      AssetDisposal[]        @relation("DisposalApprovedBy")
  disposalsCreated       AssetDisposal[]        @relation("DisposalCreatedBy")
  locationMoves          AssetLocationHistory[]
  qrCodesGenerated       AssetQRCode[]
  approvedReservations   AssetReservation[]     @relation("ReservationApprovals")
  reservations           AssetReservation[]     @relation("UserReservations")
  valuationsPerformed    AssetValuation[]
  comments               Comment[]
  depreciationSchedules  DepreciationSchedule[]
  documentsUploaded      Document[]
  documentAccessLogs     DocumentAccessLog[]
  documentAssociations   DocumentAssociation[]
  documentComments       DocumentComment[]
  documentSharedBy       DocumentShare[]        @relation("SharedBy")
  documentSharedWith     DocumentShare[]        @relation("SharedWith")
  inventoryItemsCreated  InventoryItem[]
  sentNotifications      Notification[]         @relation("NotificationSender")
  notifications          Notification[]         @relation("NotificationRecipient")
  pegClients             PEGClient[]            @relation("PEGClients")
  purchaseOrdersApproved PurchaseOrder[]        @relation("POApprovedBy")
  purchaseOrdersCreated  PurchaseOrder[]        @relation("POCreatedBy")
  purchaseOrdersReceived PurchaseOrder[]        @relation("POReceivedBy")
  refreshTokens          RefreshToken[]
  replyTemplates         ReplyTemplate[]        @relation("ReplyTemplateCreator")
  alertsAcknowledged     StockAlert[]
  stockIssues            StockTransaction[]     @relation("TransactionIssuedTo")
  stockTransactions      StockTransaction[]     @relation("TransactionPerformedBy")
  suppliersCreated       Supplier[]
  assigned               Ticket[]               @relation("AssignedTickets")
  tickets                Ticket[]               @relation("UserTickets")
  assignedTemplates      TicketTemplate[]       @relation("TemplateAssignee")
  createdTemplates       TicketTemplate[]       @relation("TemplateCreator")
  trips                  Trip[]                 @relation("UserTrips")
  sessions               UserSession[]
}

model Asset {
  id                 String                 @id @default(cuid())
  name               String
  condition          String?
  ownerId            String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  asset_code         String                 @unique
  asset_type         String?
  assigned_to        String?
  department         String?
  description        String?
  deskphones         String?
  extension          String?
  keyboard           String?
  mouse              String?
  notes              String?
  office_location    String?
  ownership          String?
  scan_datetime      String?
  scanned_by         String?
  status             String                 @default("available")
  checkoutCount      Int                    @default(0)
  checkoutStatus     String?                @default("available")
  currentBookValue   Decimal?               @db.Decimal(12, 2)
  currentHolderId    String?
  currentLocation    String?
  depreciationStatus String?                @default("not_started")
  image_url          String?
  isDepreciable      Boolean                @default(false)
  lastCheckoutDate   DateTime?
  pegClientId        String?
  purchaseDate       DateTime?
  purchasePrice      Decimal?               @db.Decimal(12, 2)
  remote_id          String?
  serial_number      String?
  currentHolder      User?                  @relation("AssetCurrentHolder", fields: [currentHolderId], references: [id])
  owner              User?                  @relation(fields: [ownerId], references: [id])
  pegClient          PEGClient?             @relation(fields: [pegClientId], references: [id])
  checkouts          AssetCheckout[]
  depreciation       AssetDepreciation[]
  disposals          AssetDisposal[]
  history            AssetHistory[]
  locationHistory    AssetLocationHistory[]
  qrCodes            AssetQRCode[]
  reservations       AssetReservation[]
  valuations         AssetValuation[]
  maintenance        MaintenanceSchedule[]
  stockTransactions  StockTransaction[]
  tickets            Ticket[]

  @@index([status])
  @@index([ownerId])
  @@index([checkoutStatus])
  @@index([currentHolderId])
  @@index([purchaseDate])
  @@index([depreciationStatus])
  @@index([isDepreciable])
  @@index([pegClientId])
}

model Ticket {
  id           String       @id @default(cuid())
  number       String       @unique
  title        String
  description  String
  status       String       @default("open")
  priority     String       @default("medium")
  createdById  String
  assignedToId String?
  assetId      String?
  resolution   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  dueDate      DateTime?
  attachments  Attachment[]
  comments     Comment[]
  asset        Asset?       @relation(fields: [assetId], references: [id])
  assignedTo   User?        @relation("AssignedTickets", fields: [assignedToId], references: [id])
  createdBy    User         @relation("UserTickets", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([priority])
  @@index([assignedToId])
  @@index([createdById])
  @@index([createdAt])
}

model Comment {
  id          String   @id @default(cuid())
  content     String
  ticketId    String
  authorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  contentHash String?  @db.VarChar(32)
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([contentHash, createdAt(sort: Desc)])
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  userId    String
  senderId  String?
  ticketId  String?
  assetId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sender    User?    @relation("NotificationSender", fields: [senderId], references: [id])
  user      User     @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String?
  userId     String?
  userEmail  String?
  userName   String?
  ipAddress  String?
  userAgent  String?
  changes    String?
  metadata   String?
  status     String   @default("success")
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

model PEGClient {
  id            String          @id @default(cuid())
  clientCode    String?         @unique
  name          String
  location      String
  contactPerson String?
  phone         String?
  email         String?
  provinceId    String
  userId        String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  assets        Asset[]
  user          User            @relation("PEGClients", fields: [userId], references: [id], onDelete: Cascade)
  routeStops    TripRouteStop[]

  @@index([userId])
  @@index([clientCode])
  @@index([provinceId])
}

model Attachment {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimetype     String
  size         Int
  url          String
  ticketId     String
  uploadedBy   String
  createdAt    DateTime @default(now())
  ticket       Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model AssetHistory {
  id          String   @id @default(cuid())
  assetId     String
  action      String
  field       String?
  oldValue    String?
  newValue    String?
  userId      String?
  userName    String?
  description String?
  createdAt   DateTime @default(now())
  asset       Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([createdAt])
}

model MaintenanceSchedule {
  id              String    @id @default(cuid())
  assetId         String
  title           String
  description     String?
  frequency       String
  nextDueDate     DateTime
  lastCompletedAt DateTime?
  assignedToId    String?
  status          String    @default("scheduled")
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([nextDueDate])
  @@index([status])
}

model SavedFilter {
  id         String   @id @default(cuid())
  userId     String
  name       String
  entityType String
  filters    String
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([entityType])
}

model DashboardWidget {
  id         String   @id @default(cuid())
  userId     String
  widgetType String
  position   Int
  size       String   @default("medium")
  settings   String?
  visible    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
  @@index([position])
}

model LoginHistory {
  id            String   @id @default(cuid())
  userId        String
  userEmail     String
  ipAddress     String?
  userAgent     String?
  location      String?
  device        String?
  browser       String?
  success       Boolean  @default(true)
  failureReason String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Trip {
  id          String          @id @default(cuid())
  destination String
  country     String?
  startDate   DateTime
  endDate     DateTime
  category    String
  status      String
  budget      Float           @default(0)
  spent       Float           @default(0)
  notes       String?
  itinerary   Json?
  userId      String
  isPegRoute  Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  user        User            @relation("UserTrips", fields: [userId], references: [id], onDelete: Cascade)
  routeStops  TripRouteStop[]

  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([startDate])
  @@index([isPegRoute])
}

model TripRouteStop {
  id         String    @id @default(cuid())
  tripId     String
  clientId   String
  visitDate  DateTime
  visitTime  String?
  duration   Int?
  travelTime Int?
  notes      String?
  order      Int
  status     String    @default("planned")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  client     PEGClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  trip       Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([tripId, clientId, order])
  @@index([tripId])
  @@index([clientId])
  @@index([visitDate])
}

model WorkflowTemplate {
  id          String              @id @default(cuid())
  name        String
  description String?
  entityType  String
  trigger     String
  conditions  Json?
  actions     Json
  isActive    Boolean             @default(true)
  priority    Int                 @default(0)
  createdBy   String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  executions  WorkflowExecution[]

  @@index([entityType])
  @@index([trigger])
  @@index([isActive])
}

model WorkflowExecution {
  id          String           @id @default(cuid())
  workflowId  String
  entityType  String
  entityId    String
  status      String
  result      Json?
  error       String?
  executedAt  DateTime         @default(now())
  completedAt DateTime?
  workflow    WorkflowTemplate @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([entityId])
  @@index([status])
  @@index([executedAt])
}

model AutoAssignmentRule {
  id             String   @id @default(cuid())
  name           String
  description    String?
  isActive       Boolean  @default(true)
  priority       Int      @default(0)
  conditions     Json
  assignmentType String
  targetUserId   String?
  targetUserIds  Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([isActive])
  @@index([priority])
}

model SLAPolicy {
  id                    String   @id @default(cuid())
  name                  String
  description           String?
  priority              String
  responseTimeMinutes   Int
  resolutionTimeMinutes Int
  businessHoursOnly     Boolean  @default(true)
  escalationEnabled     Boolean  @default(true)
  escalationUserId      String?
  notifyBeforeMinutes   Int      @default(30)
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([priority])
  @@index([isActive])
}

model TicketSLA {
  id                 String    @id @default(cuid())
  ticketId           String    @unique
  policyId           String
  responseDeadline   DateTime
  resolutionDeadline DateTime
  firstResponseAt    DateTime?
  resolvedAt         DateTime?
  status             String
  responseBreached   Boolean   @default(false)
  resolutionBreached Boolean   @default(false)
  warningsSent       Int       @default(0)
  escalated          Boolean   @default(false)
  escalatedAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([ticketId])
  @@index([status])
  @@index([responseDeadline])
  @@index([resolutionDeadline])
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  isRevoked Boolean   @default(false)
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model UserSession {
  id             String   @id @default(cuid())
  userId         String
  sessionToken   String   @unique
  ipAddress      String?
  userAgent      String?
  device         String?
  browser        String?
  location       String?
  fingerprint    String?
  isActive       Boolean  @default(true)
  lastActivityAt DateTime @default(now())
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([isActive])
  @@index([expiresAt])
}

model WebhookLog {
  id        String   @id @default(cuid())
  source    String
  event     String
  payload   String
  signature String?
  verified  Boolean  @default(false)
  processed Boolean  @default(false)
  error     String?
  createdAt DateTime @default(now())

  @@index([source])
  @@index([processed])
  @@index([createdAt])
}

model SecurityEvent {
  id         String    @id @default(cuid())
  eventType  String
  severity   String
  userId     String?
  userEmail  String?
  ipAddress  String?
  userAgent  String?
  details    String?
  resolved   Boolean   @default(false)
  resolvedBy String?
  resolvedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([eventType])
  @@index([severity])
  @@index([userId])
  @@index([resolved])
  @@index([createdAt])
}

model TicketTemplate {
  id                String   @id @default(cuid())
  name              String
  description       String?
  title             String
  ticketDescription String
  priority          String   @default("medium")
  category          String?
  tags              String[]
  assignedToId      String?
  isActive          Boolean  @default(true)
  createdById       String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  assignedTo        User?    @relation("TemplateAssignee", fields: [assignedToId], references: [id])
  createdBy         User     @relation("TemplateCreator", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([assignedToId])
  @@index([isActive])
  @@index([category])
}

model ReplyTemplate {
  id          String   @id @default(cuid())
  name        String
  content     String
  category    String?
  isActive    Boolean  @default(true)
  usageCount  Int      @default(0)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User     @relation("ReplyTemplateCreator", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([category])
  @@index([isActive])
}

model AssetCheckout {
  id                      String                 @id @default(cuid())
  assetId                 String
  userId                  String
  checkedOutById          String
  checkoutDate            DateTime               @default(now())
  expectedReturnDate      DateTime?
  actualReturnDate        DateTime?
  checkedInById           String?
  checkinDate             DateTime?
  status                  String                 @default("checked_out")
  location                String?
  purpose                 String?
  notes                   String?
  condition               String?
  returnCondition         String?
  returnNotes             String?
  overdueNotificationSent Boolean                @default(false)
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  asset                   Asset                  @relation(fields: [assetId], references: [id], onDelete: Cascade)
  checkedInBy             User?                  @relation("CheckedInBy", fields: [checkedInById], references: [id])
  checkedOutBy            User                   @relation("CheckedOutBy", fields: [checkedOutById], references: [id])
  user                    User                   @relation("CheckoutUser", fields: [userId], references: [id])
  locationHistory         AssetLocationHistory[]
  reminders               CheckoutReminder[]

  @@index([assetId])
  @@index([userId])
  @@index([status])
  @@index([checkoutDate])
  @@index([expectedReturnDate])
  @@index([actualReturnDate])
}

model AssetQRCode {
  id            String    @id @default(cuid())
  assetId       String
  qrCode        String    @unique
  qrCodeUrl     String?
  generatedAt   DateTime  @default(now())
  generatedById String
  lastScannedAt DateTime?
  scanCount     Int       @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  asset         Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  generatedBy   User      @relation(fields: [generatedById], references: [id])

  @@index([assetId])
  @@index([qrCode])
  @@index([isActive])
}

model AssetLocationHistory {
  id               String         @id @default(cuid())
  assetId          String
  checkoutId       String?
  location         String
  previousLocation String?
  movedById        String
  movedAt          DateTime       @default(now())
  reason           String?
  notes            String?
  createdAt        DateTime       @default(now())
  asset            Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  checkout         AssetCheckout? @relation(fields: [checkoutId], references: [id])
  movedBy          User           @relation(fields: [movedById], references: [id])

  @@index([assetId])
  @@index([checkoutId])
  @@index([movedAt])
}

model CheckoutReminder {
  id           String        @id @default(cuid())
  checkoutId   String
  reminderDate DateTime
  reminderType String
  sent         Boolean       @default(false)
  sentAt       DateTime?
  emailSent    Boolean       @default(false)
  whatsappSent Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  checkout     AssetCheckout @relation(fields: [checkoutId], references: [id], onDelete: Cascade)

  @@index([checkoutId])
  @@index([reminderDate])
  @@index([sent])
}

model InventoryItem {
  id                 String              @id @default(cuid())
  itemCode           String              @unique
  name               String
  description        String?
  category           String
  subcategory        String?
  unit               String
  unitPrice          Decimal?            @db.Decimal(10, 2)
  currency           String              @default("USD")
  currentStock       Int                 @default(0)
  minimumStock       Int                 @default(0)
  maximumStock       Int?
  reorderPoint       Int                 @default(0)
  reorderQuantity    Int                 @default(0)
  location           String?
  binLocation        String?
  barcode            String?             @unique
  sku                String?
  manufacturer       String?
  model              String?
  tags               String[]
  imageUrl           String?
  isActive           Boolean             @default(true)
  trackSerial        Boolean             @default(false)
  notes              String?
  createdById        String
  lastStockedAt      DateTime?
  lastOrderedAt      DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  createdBy          User                @relation(fields: [createdById], references: [id])
  purchaseOrderItems PurchaseOrderItem[]
  alerts             StockAlert[]
  transactions       StockTransaction[]

  @@index([itemCode])
  @@index([category])
  @@index([currentStock])
  @@index([isActive])
  @@index([barcode])
  @@index([createdById])
}

model StockTransaction {
  id              String         @id @default(cuid())
  itemId          String
  transactionType String
  quantity        Int
  unitPrice       Decimal?       @db.Decimal(10, 2)
  totalCost       Decimal?       @db.Decimal(10, 2)
  balanceBefore   Int
  balanceAfter    Int
  reference       String?
  notes           String?
  location        String?
  supplierId      String?
  purchaseOrderId String?
  issuedToId      String?
  issuedToAssetId String?
  performedById   String
  transactionDate DateTime       @default(now())
  createdAt       DateTime       @default(now())
  issuedToAsset   Asset?         @relation(fields: [issuedToAssetId], references: [id])
  issuedTo        User?          @relation("TransactionIssuedTo", fields: [issuedToId], references: [id])
  item            InventoryItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  performedBy     User           @relation("TransactionPerformedBy", fields: [performedById], references: [id])
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  supplier        Supplier?      @relation(fields: [supplierId], references: [id])

  @@index([itemId])
  @@index([transactionType])
  @@index([transactionDate])
  @@index([performedById])
  @@index([supplierId])
}

model Supplier {
  id                String             @id @default(cuid())
  supplierCode      String             @unique
  name              String
  contactPerson     String?
  email             String?
  phone             String?
  website           String?
  address           String?
  city              String?
  state             String?
  postalCode        String?
  country           String?
  taxId             String?
  paymentTerms      String?
  creditLimit       Decimal?           @db.Decimal(10, 2)
  rating            Int?
  notes             String?
  isActive          Boolean            @default(true)
  createdById       String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  purchaseOrders    PurchaseOrder[]
  stockTransactions StockTransaction[]
  createdBy         User               @relation(fields: [createdById], references: [id])

  @@index([supplierCode])
  @@index([isActive])
  @@index([name])
}

model PurchaseOrder {
  id                   String              @id @default(cuid())
  orderNumber          String              @unique
  supplierId           String
  status               String              @default("draft")
  orderDate            DateTime            @default(now())
  expectedDeliveryDate DateTime?
  actualDeliveryDate   DateTime?
  subtotal             Decimal             @default(0) @db.Decimal(10, 2)
  taxAmount            Decimal             @default(0) @db.Decimal(10, 2)
  shippingCost         Decimal             @default(0) @db.Decimal(10, 2)
  totalAmount          Decimal             @default(0) @db.Decimal(10, 2)
  currency             String              @default("USD")
  paymentStatus        String              @default("pending")
  paymentMethod        String?
  notes                String?
  shippingAddress      String?
  billingAddress       String?
  createdById          String
  approvedById         String?
  approvedAt           DateTime?
  receivedById         String?
  receivedAt           DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  approvedBy           User?               @relation("POApprovedBy", fields: [approvedById], references: [id])
  createdBy            User                @relation("POCreatedBy", fields: [createdById], references: [id])
  receivedBy           User?               @relation("POReceivedBy", fields: [receivedById], references: [id])
  supplier             Supplier            @relation(fields: [supplierId], references: [id])
  items                PurchaseOrderItem[]
  stockTransactions    StockTransaction[]

  @@index([orderNumber])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@index([paymentStatus])
}

model PurchaseOrderItem {
  id               String        @id @default(cuid())
  purchaseOrderId  String
  itemId           String
  quantity         Int
  unitPrice        Decimal       @db.Decimal(10, 2)
  totalPrice       Decimal       @db.Decimal(10, 2)
  receivedQuantity Int           @default(0)
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  item             InventoryItem @relation(fields: [itemId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([itemId])
}

model StockAlert {
  id               String        @id @default(cuid())
  itemId           String
  alertType        String
  severity         String        @default("medium")
  message          String
  triggeredAt      DateTime      @default(now())
  acknowledged     Boolean       @default(false)
  acknowledgedById String?
  acknowledgedAt   DateTime?
  resolved         Boolean       @default(false)
  resolvedAt       DateTime?
  createdAt        DateTime      @default(now())
  acknowledgedBy   User?         @relation(fields: [acknowledgedById], references: [id])
  item             InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([alertType])
  @@index([acknowledged])
  @@index([resolved])
}

model AssetDepreciation {
  id                        String                 @id @default(cuid())
  assetId                   String
  depreciationMethod        String
  purchasePrice             Decimal                @db.Decimal(12, 2)
  salvageValue              Decimal                @default(0) @db.Decimal(12, 2)
  usefulLifeYears           Int
  usefulLifeMonths          Int                    @default(0)
  purchaseDate              DateTime
  depreciationStartDate     DateTime
  currentBookValue          Decimal                @db.Decimal(12, 2)
  accumulatedDepreciation   Decimal                @default(0) @db.Decimal(12, 2)
  annualDepreciationRate    Decimal?               @db.Decimal(5, 2)
  monthlyDepreciationAmount Decimal?               @db.Decimal(12, 2)
  isActive                  Boolean                @default(true)
  notes                     String?
  lastCalculatedAt          DateTime?
  createdById               String
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt
  asset                     Asset                  @relation(fields: [assetId], references: [id], onDelete: Cascade)
  createdBy                 User                   @relation(fields: [createdById], references: [id])
  schedule                  DepreciationSchedule[]

  @@index([assetId])
  @@index([depreciationMethod])
  @@index([isActive])
  @@index([depreciationStartDate])
}

model DepreciationSchedule {
  id                      String            @id @default(cuid())
  depreciationId          String
  periodNumber            Int
  periodStartDate         DateTime
  periodEndDate           DateTime
  openingBookValue        Decimal           @db.Decimal(12, 2)
  depreciationAmount      Decimal           @db.Decimal(12, 2)
  accumulatedDepreciation Decimal           @db.Decimal(12, 2)
  closingBookValue        Decimal           @db.Decimal(12, 2)
  isPosted                Boolean           @default(false)
  postedAt                DateTime?
  postedById              String?
  fiscalYear              Int
  fiscalMonth             Int
  notes                   String?
  createdAt               DateTime          @default(now())
  depreciation            AssetDepreciation @relation(fields: [depreciationId], references: [id], onDelete: Cascade)
  postedBy                User?             @relation(fields: [postedById], references: [id])

  @@index([depreciationId])
  @@index([fiscalYear])
  @@index([fiscalMonth])
  @@index([isPosted])
  @@index([periodEndDate])
}

model AssetValuation {
  id                String   @id @default(cuid())
  assetId           String
  valuationDate     DateTime
  valuationType     String
  bookValue         Decimal  @db.Decimal(12, 2)
  marketValue       Decimal? @db.Decimal(12, 2)
  replacementValue  Decimal? @db.Decimal(12, 2)
  condition         String?
  valuedById        String
  appraisedBy       String?
  appraisalDocument String?
  notes             String?
  createdAt         DateTime @default(now())
  asset             Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  valuedBy          User     @relation(fields: [valuedById], references: [id])

  @@index([assetId])
  @@index([valuationDate])
  @@index([valuationType])
}

model AssetDisposal {
  id                    String    @id @default(cuid())
  assetId               String
  disposalDate          DateTime
  disposalMethod        String
  reason                String
  bookValueAtDisposal   Decimal   @db.Decimal(12, 2)
  disposalProceeds      Decimal   @default(0) @db.Decimal(12, 2)
  gainLoss              Decimal   @default(0) @db.Decimal(12, 2)
  disposedToParty       String?
  authorizationDocument String?
  approvedById          String?
  approvedAt            DateTime?
  notes                 String?
  createdById           String
  createdAt             DateTime  @default(now())
  approvedBy            User?     @relation("DisposalApprovedBy", fields: [approvedById], references: [id])
  asset                 Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  createdBy             User      @relation("DisposalCreatedBy", fields: [createdById], references: [id])

  @@index([assetId])
  @@index([disposalDate])
  @@index([disposalMethod])
}

model DocumentCategory {
  id               String             @id @default(cuid())
  name             String
  description      String?
  icon             String?
  color            String?
  parentCategoryId String?
  isActive         Boolean            @default(true)
  sortOrder        Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  documents        Document[]
  parentCategory   DocumentCategory?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  subCategories    DocumentCategory[] @relation("CategoryHierarchy")

  @@index([parentCategoryId])
  @@index([isActive])
}

model Document {
  id               String                @id @default(cuid())
  title            String
  description      String?
  categoryId       String?
  fileName         String
  originalFileName String
  filePath         String
  fileSize         BigInt
  mimeType         String
  version          Int                   @default(1)
  versionLabel     String?
  isLatestVersion  Boolean               @default(true)
  parentDocumentId String?
  status           String                @default("active")
  tags             String[]
  metadata         Json?
  uploadedById     String
  uploadedAt       DateTime              @default(now())
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  category         DocumentCategory?     @relation(fields: [categoryId], references: [id])
  parentDocument   Document?             @relation("DocumentVersions", fields: [parentDocumentId], references: [id], onDelete: Cascade)
  versions         Document[]            @relation("DocumentVersions")
  uploadedBy       User                  @relation(fields: [uploadedById], references: [id])
  accessLogs       DocumentAccessLog[]
  associations     DocumentAssociation[]
  comments         DocumentComment[]
  shares           DocumentShare[]

  @@index([categoryId])
  @@index([uploadedById])
  @@index([parentDocumentId])
  @@index([status])
  @@index([isLatestVersion])
  @@index([createdAt])
  @@index([uploadedAt])
}

model DocumentAssociation {
  id               String   @id @default(cuid())
  documentId       String
  entityType       String
  entityId         String
  relationshipType String?
  notes            String?
  createdById      String
  createdAt        DateTime @default(now())
  createdBy        User     @relation(fields: [createdById], references: [id])
  document         Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([entityType, entityId])
  @@index([createdById])
}

model DocumentAccessLog {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  action     String
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model DocumentShare {
  id               String    @id @default(cuid())
  documentId       String
  sharedWithUserId String?
  sharedWithRole   String?
  permissions      String[]  @default(["view"])
  expiresAt        DateTime?
  sharedById       String
  message          String?
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  document         Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  sharedBy         User      @relation("SharedBy", fields: [sharedById], references: [id], onDelete: Cascade)
  sharedWithUser   User?     @relation("SharedWith", fields: [sharedWithUserId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([sharedWithUserId])
  @@index([sharedWithRole])
  @@index([isActive])
  @@index([expiresAt])
}

model DocumentComment {
  id              String            @id @default(cuid())
  documentId      String
  userId          String
  comment         String
  parentCommentId String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  document        Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  parentComment   DocumentComment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         DocumentComment[] @relation("CommentReplies")
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([parentCommentId])
}

model AssetReservation {
  id               String    @id @default(cuid())
  assetId          String
  userId           String
  reservationStart DateTime
  reservationEnd   DateTime
  status           String    @default("pending")
  purpose          String?
  notes            String?
  approvedById     String?
  approvedAt       DateTime?
  rejectedReason   String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  approvedBy       User?     @relation("ReservationApprovals", fields: [approvedById], references: [id])
  asset            Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  user             User      @relation("UserReservations", fields: [userId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([userId])
  @@index([status])
  @@index([reservationStart])
  @@index([reservationEnd])
}

model EmailNotificationLog {
  id         String   @id @default(cuid())
  recipient  String
  subject    String
  body       String
  type       String
  entityType String?
  entityId   String?
  status     String   @default("sent")
  error      String?
  sentAt     DateTime @default(now())

  @@index([recipient])
  @@index([type])
  @@index([status])
  @@index([sentAt])
}

model ExportImportHistory {
  id          String   @id @default(cuid())
  operation   String
  entityType  String
  format      String
  recordCount Int      @default(0)
  fileName    String
  filePath    String?
  userId      String
  status      String   @default("completed")
  error       String?
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([operation])
  @@index([entityType])
  @@index([createdAt])
}

model ApiRateLimit {
  id           String   @id @default(cuid())
  userId       String
  endpoint     String
  requestCount Int      @default(0)
  windowStart  DateTime @default(now())
  windowEnd    DateTime
  isBlocked    Boolean  @default(false)

  @@unique([userId, endpoint, windowStart])
  @@index([userId])
  @@index([windowStart])
}

model KeyboardShortcut {
  id        String   @id @default(cuid())
  userId    String
  action    String
  keys      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, action])
  @@index([userId])
}

enum Role {
  ADMIN
  USER
  TECHNICIAN
  PEG
}
